name: Release (tag) â€” Build & Publish to GitHub Pages

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

env:
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Replace indev version with tag
        env:
          # GITHUB_REF is like refs/tags/<tag>
          TAG: ${{ github.ref_name }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag='$TAG'"
          set -e

          # find files containing the exact version marker
          FILES=$(git grep -l 'let version = "indev"' || true)
          if [ -z "$FILES" ]; then
            echo "No files found with 'let version = \"indev\"'"
          else
            echo "Updating files:"
            echo "$FILES"
            for f in $FILES; do
              echo "Updating $f"
              # safe in-place replace, preserves other matches
              perl -0777 -pe "s/let version =\s*\"indev\"/let version = \"$TAG\"/g" -i "$f"
            done

            echo "Replacement complete; no git commands were executed by this workflow step."
          fi

      - name: Create release branch with patched source
        env:
          TAG: ${{ github.ref_name }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          BRANCH="release-${TAG}"
          echo "Preparing branch: $BRANCH"
          set -e

          # Find modified files (only commit patched sources)
          MODIFIED=$(git ls-files -m)
          if [ -z "$MODIFIED" ]; then
            echo "No modified files to commit; skipping branch creation."
          else
            echo "Modified files to commit:"
            echo "$MODIFIED"

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            # create branch and commit only the modified files
            git checkout -b "$BRANCH"
            git add $MODIFIED
            git commit -m "chore(release): update version to $TAG"

            # push branch to origin
            git push origin HEAD:"$BRANCH"
            echo "Pushed branch: $BRANCH"
          fi

      - name: Build & Package (single step)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          retry() { n=0; until [ $n -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry #$n for: $*"; sleep 5; done; if [ $n -ge 3 ]; then echo "Command failed after retries: $*"; exit 1; fi }

          # ensure pxt CLI is present
          command -v pxt >/dev/null 2>&1 || npm install -g pxt

          # read target id and show repo for debugging
          TARGET=$(node -e "console.log(require('./pxt.json').targetVersions?.targetId || 'arcade')")
          echo "Using PXT target: $TARGET"
          echo "Repo root files:"
          ls -la || true

          # install target
          retry pxt target "$TARGET"

          # ensure the installed target is built (creates built/pxt.js needed by staticpkg)
          TARGET_DIR="node_modules/pxt-$TARGET"
          if [ -d "$TARGET_DIR" ]; then
            echo "Building PXT target in $TARGET_DIR"
            pushd "$TARGET_DIR"
            echo "Target dir files:"
            ls -la || true
            echo "package.json scripts:"; jq -r '.scripts // {}' package.json || true

            # install target deps and run its build script (retry on transient failures)
            retry bash -lc "npm ci --no-audit --no-fund || npm install --no-audit --no-fund"
            retry bash -lc "npm run build"

            echo "Built files in target/built:"; ls -la built || true
            echo "Built files in target/node_modules/pxt-core/built:"; ls -la node_modules/pxt-core/built || true
            popd
          else
            echo "Warning: target dir $TARGET_DIR not found; staticpkg may fail"
          fi

          # install project packages and build
          pxt install
          pxt build

          TARGET_DIR="node_modules/pxt-$TARGET"
          OUTPUT_DIR="$GITHUB_WORKSPACE/built/packaged"
          echo "Using target dir: $TARGET_DIR; output: $OUTPUT_DIR"

          if [ -d "$TARGET_DIR" ]; then
            pushd "$TARGET_DIR"
            echo "Running staticpkg in: $(pwd)"
            retry pxt staticpkg --route "$REPO_NAME" --output "$OUTPUT_DIR"
            popd
          else
            echo "Warning: target dir $TARGET_DIR not found, attempting to run staticpkg from repository root"
            retry pxt staticpkg --route "$REPO_NAME" --output "$OUTPUT_DIR"
          fi

          # debug listing
          echo "Packaged output contents:"
          ls -la "$OUTPUT_DIR" || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./built/packaged/${{ env.REPO_NAME }}
