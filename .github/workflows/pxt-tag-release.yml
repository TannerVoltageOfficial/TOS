name: Release (tag) â€” Build & Publish to GitHub Pages

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

env:
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pxt CLI
        run: npm install -g pxt

      - name: Replace indev version with tag
        env:
          # GITHUB_REF is like refs/tags/<tag>
          TAG: ${{ github.ref_name }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Tag='$TAG'"
          set -e

          # find files containing the exact version marker
          FILES=$(git grep -l 'let version = "indev"' || true)
          if [ -z "$FILES" ]; then
            echo "No files found with 'let version = \"indev\"'"
          else
            echo "Updating files:"
            echo "$FILES"
            for f in $FILES; do
              echo "Updating $f"
              # safe in-place replace, preserves other matches
              perl -0777 -pe "s/let version =\s*\"indev\"/let version = \"$TAG\"/g" -i "$f"
            done

            echo "Replacement complete; no git commands were executed by this workflow step."
          fi

      - name: Prepare PXT target (no npm install in repo root)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          retry() { n=0; until [ $n -ge 3 ]; do "$@" && break; n=$((n+1)); echo "Retry #$n for: $*"; sleep 5; done; if [ $n -ge 3 ]; then echo "Command failed after retries: $*"; exit 1; fi }

          # read target id from pxt.json (fallback to 'arcade')
          TARGET=$(node -e "console.log(require('./pxt.json').targetVersions?.targetId || 'arcade')")
          echo "Using PXT target: $TARGET"

          # show repo layout for debugging
          echo "Repo root files:"
          ls -la || true
          echo "node_modules (if present):"
          ls -la node_modules || true

          # ensure pxt CLI is present
          command -v pxt >/dev/null 2>&1 || npm install -g pxt

          # install target using pxt (retry for transient failures)
          retry pxt target "$TARGET"
          echo "Installed target; node_modules should contain pxt-$TARGET"

      - name: Build and package site
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          # install project packages and build
          pxt install
          pxt build

          TARGET_DIR="node_modules/pxt-$TARGET"
          OUTPUT_DIR="$GITHUB_WORKSPACE/built/packaged"
          echo "Using target dir: $TARGET_DIR; output: $OUTPUT_DIR"

          if [ -d "$TARGET_DIR" ]; then
            pushd "$TARGET_DIR"
            echo "Running staticpkg in: $(pwd)"
            retry pxt staticpkg --route "$REPO_NAME" --output "$OUTPUT_DIR"
            popd
          else
            echo "Warning: target dir $TARGET_DIR not found, attempting to run staticpkg from repository root"
            retry pxt staticpkg --route "$REPO_NAME" --output "$OUTPUT_DIR"
          fi

          # debug listing
          echo "Packaged output contents:"
          ls -la "$OUTPUT_DIR" || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./built/packaged/${{ env.REPO_NAME }}
