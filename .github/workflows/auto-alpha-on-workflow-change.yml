name: Auto alpha on workflow changes

on:
  push:
    branches: [ "master" ]
    paths:
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  create-alpha-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create next alpha tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Fetch remote tags
          git fetch --prune --tags

          # Find next numeric suffix for 1.0.0-alphaN
          highest=$(git tag -l '1.0.0-alpha*' | sed -E 's/^.*alpha([0-9]+)$/\1/' | sort -n | tail -n1 || true)
          if [ -z "$highest" ]; then
            highest=0
          fi

          next=$((highest+1))
          tag="1.0.0-alpha${next}"

          # Avoid race: increment until tag does not exist remotely
          while git ls-remote --tags origin | grep -q "refs/tags/$tag"; do
            highest=$((highest+1))
            next=$((highest+1))
            tag="1.0.0-alpha${next}"
          done

          echo "Creating tag: $tag"
          git tag -a "$tag" -m "auto-release: $tag (workflows changed)"
          git push origin "refs/tags/$tag"

      - name: Output tag
        run: echo "Created tag: $(git tag --sort=-creatordate | head -n1)"